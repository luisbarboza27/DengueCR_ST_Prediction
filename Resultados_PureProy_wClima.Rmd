---
title: "Resultados_PureProy_wClima"
output: html_notebook
---

```{r}
library(tidyverse)
library(lubridate)
library(sf)
library(spdep)
library(cowplot)
library(kableExtra)
library(Rankcluster)
library(stringr)
```

```{r}
load('Resultados_PureProy_wClima_defTS6.RData')
metricas_tot_GAM <- metricas_tot_GAM %>% mutate(Model='GAMLSS')

mejores_GAM <- sort(metricas_tot_GAM$NIS_95,index.return=T)$ix[1:6] 

nombres_cantones$Canton[mejores_GAM]
peores_GAM <- sort(metricas_tot_GAM$NIS_95,decreasing =T,index.return=T)$ix[1:3] 
nombres_cantones$Canton[peores_GAM]

indices_cantones_GAM <- c(mejores_GAM,peores_GAM)

nombres_GAM <- nombres_cantones$Canton[indices_cantones_GAM]


indice <- indices_cantones
base_grafico_lista_GAM <- function(indice){
  RR_obs <- bases_ent[[indice]] %>%
    dplyr::select(RR)
  fechas <- bases_ent[[indice]] %>% 
    dplyr::select(Year,Month) %>% mutate(fecha=make_date(Year,Month,1))
  base_grafico <- predicciones_in_GAM[[indice]] %>% bind_cols(RR_obs) %>%
    mutate(fechas=fechas$fecha,Canton=nombres_cantones$Canton[indice])
  return(base_grafico)
}

base_grafico_GAM <- map_dfr(indices_cantones_GAM,~base_grafico_lista_GAM(.))


base_grafico_lista_2_GAM <- function(indice){
  RR_obs <- bases_test[[indice]] %>%
    dplyr::select(RR)
  fechas <- bases_test[[indice]] %>% 
    dplyr::select(Year,Month) %>% mutate(fecha=make_date(Year,Month,1))
  predicciones <- data.frame(fit=predicciones_out_GAM[[indice]])
  quantiles <- data.frame(low = quantiles_out_GAM[[indice]][1,],
                          up = quantiles_out_GAM[[indice]][2,])
  base_grafico <- predicciones %>% bind_cols(quantiles) %>%
    bind_cols(RR_obs) %>%
    mutate(fechas=fechas$fecha,Canton=nombres_cantones$Canton[indice])
  return(base_grafico)
}

base_grafico_out_GAM<- map_dfr(indices_cantones_GAM,~base_grafico_lista_2_GAM(.))

metricas_tot_RF <- metricas_tot_RF %>% mutate(Model='RF')
metricas_tot <- bind_rows(metricas_tot_RF,metricas_tot_GAM)

mejores_RF <- sort(metricas_tot_RF$NIS_95,index.return=T)$ix[1:6] 
nombres_cantones$Canton[mejores_RF]
peores_RF <- sort(metricas_tot_RF$NIS_95,decreasing = T,index.return=T)$ix[1:3] 
nombres_cantones$Canton[peores_RF]

indices_cantones_RF <- c(mejores_RF,peores_RF)

nombres_RF <- nombres_cantones$Canton[indices_cantones_RF]


indice <- indices_cantones
base_grafico_lista_RF <- function(indice){
  RR_obs <- bases_ent[[indice]] %>%
    dplyr::select(RR)
  fechas <- bases_ent[[indice]] %>% 
    dplyr::select(Year,Month) %>% mutate(fecha=make_date(Year,Month,1))
  base_grafico <- predicciones_in_RF[[indice]] %>% bind_cols(RR_obs) %>%
    mutate(fechas=fechas$fecha,Canton=nombres_cantones$Canton[indice])
  colnames(base_grafico)[1] <- 'fit'
  return(base_grafico)
}

base_grafico_RF <- map_dfr(indices_cantones_RF,~base_grafico_lista_RF(.))

base_grafico_lista_2_RF <- function(indice){
  RR_obs <- bases_test[[indice]] %>%
    dplyr::select(RR)
  fechas <- bases_test[[indice]] %>% 
    dplyr::select(Year,Month) %>% mutate(fecha=make_date(Year,Month,1))
  predicciones <- data.frame(fit=predicciones_out_RF[[indice]])
  quantiles <- data.frame(low = quantiles_out_RF[[indice]][1,],
                          up = quantiles_out_RF[[indice]][2,])
  base_grafico <- predicciones %>% bind_cols(quantiles) %>%
    bind_cols(RR_obs) %>%
    mutate(fechas=fechas$fecha,Canton=nombres_cantones$Canton[indice])
  return(base_grafico)
}

base_grafico_out_RF<- map_dfr(indices_cantones_RF,~base_grafico_lista_2_RF(.))

metricas_tot_mj <- metricas_tot %>% group_by(Canton) %>% slice(which.min(NIS_95)) %>% ungroup()

mejores_mj <- sort(metricas_tot_mj$NIS_95,index.return=T)$ix[1:6] 
nombres_cantones$Canton[mejores_mj]
peores_mj <- sort(metricas_tot_mj$NIS_95,decreasing = T,index.return=T)$ix[1:3] 
nombres_cantones$Canton[peores_mj]

indices_cantones_mj <- c(mejores_mj,peores_mj)

nombres_mj <- nombres_cantones$Canton[indices_cantones_mj]

base_grafico_lista_mj <- function(indice){
  RR_obs <- bases_ent[[indice]] %>%
    dplyr::select(RR)
  fechas <- bases_ent[[indice]] %>% 
    dplyr::select(Year,Month) %>% mutate(fecha=make_date(Year,Month,1))
  if(metricas_tot_mj[indice,"Model"]=='GAMLSS'){
    base_grafico <- predicciones_in_GAM[[indice]] %>% bind_cols(RR_obs) %>%
    mutate(fechas=fechas$fecha,Canton=nombres_cantones$Canton[indice])
  }else{
    base_grafico <- predicciones_in_RF[[indice]] %>% bind_cols(RR_obs) %>%
    mutate(fechas=fechas$fecha,Canton=nombres_cantones$Canton[indice])
  }
  colnames(base_grafico)[1] <- 'fit'
  return(base_grafico)
}

base_grafico_mj <- map_dfr(indices_cantones_mj,~base_grafico_lista_mj(.))

base_grafico_lista_2_mj <- function(indice){
  RR_obs <- bases_test[[indice]] %>%
    dplyr::select(RR)
  fechas <- bases_test[[indice]] %>% 
    dplyr::select(Year,Month) %>% mutate(fecha=make_date(Year,Month,1))
  if(metricas_tot_mj[indice,"Model"]=='GAMLSS'){
    predicciones <- data.frame(fit=predicciones_out_GAM[[indice]])
    quantiles <- data.frame(low = quantiles_out_GAM[[indice]][1,],
                          up = quantiles_out_GAM[[indice]][2,])
  }else{
    predicciones <- data.frame(fit=predicciones_out_RF[[indice]])
    quantiles <- data.frame(low = quantiles_out_RF[[indice]][1,],
                          up = quantiles_out_RF[[indice]][2,])
  }
  base_grafico <- predicciones %>% bind_cols(quantiles) %>%
    bind_cols(RR_obs) %>%
    mutate(fechas=fechas$fecha,Canton=nombres_cantones$Canton[indice])
  return(base_grafico)
}

base_grafico_out_mj<- map_dfr(indices_cantones_mj,~base_grafico_lista_2_mj(.))
```

Histograma de las diferencias entre los NIS de ambos algoritmos y diagramas de caja:
```{r}
metricas_tot <- metricas_tot %>% drop_na() %>%
  filter(NRMSE < 1e2,NIS_95 < 1e2)

caja_NIS <- ggplot(data = metricas_tot) +
  geom_boxplot(mapping = aes(y=NIS_95,fill=Model))+
  theme(axis.text.x = element_blank())+
  theme_bw()

dens_NIS <- ggplot(data = metricas_tot,mapping = aes(x=NIS_95,fill=Model)) +
  geom_density(alpha=2)+
  theme(axis.text.x = element_blank())+
  theme_bw()
  
caja_NRMSE <- ggplot(data = metricas_tot) +
  geom_boxplot(mapping = aes(y=NRMSE,fill=Model))

D_NIS <- data.frame(D = metricas_tot_RF$NIS_95-metricas_tot_GAM$NIS_95)
histograma_NIS <- ggplot(data = D_NIS)+ 
  geom_histogram(mapping = aes(x = D),bins = 4,fill='white',col=1)+
  theme_bw()

show(caja_NIS)
show(caja_NRMSE)
show(histograma_NIS)

#save_plot('caja_NIS.pdf',plot = caja_NIS)
#caja_NIS 614X352
```

Predicciones en mejores y peores GAM:
```{r}
grafico_out_GAM <- ggplot(data = base_grafico_out_GAM,mapping = aes(x = fechas,y = fit)) + 
  geom_line(col=2)+
  geom_line(mapping = aes(y=RR))+
  geom_ribbon(mapping = aes(ymin = low, ymax = up),fill=2,alpha=0.5) +
  theme_bw()+
  facet_wrap(facets = vars(factor(Canton,levels = nombres_GAM)),ncol = 3,scales = 'free')+
  xlab('Time')+ylab('Relative Risk')
show(grafico_out_GAM)  #grafico_out_GAM 800X457 
#save_plot(filename = 'grafico_out_GAM.pdf',plot = grafico_out_GAM,base_asp = 2.5)
#save_plot(filename = 'grafico_out_GAM.png',plot = grafico_out_GAM,base_asp = 2.5)
```

Predicciones en mejores y peores RF:
```{r}
grafico_out_RF <- ggplot(data = base_grafico_out_RF,mapping = aes(x = fechas,y = fit)) + 
  geom_line(col=2)+
  geom_line(mapping = aes(y=RR))+
  geom_ribbon(mapping = aes(ymin = low, ymax = up),fill=2,alpha=0.5) +
  theme_bw()+
  facet_wrap(facets = vars(factor(Canton,levels = nombres_RF)),ncol = 3,scales = 'free')+
  xlab('Time')+ylab('Relative Risk')
show(grafico_out_RF)
#save_plot(filename = 'grafico_out_RF.pdf',plot = grafico_out_RF,base_asp = 2.5)
```

Predicciones en mejores y peores:
```{r}
grafico_out_mj <- ggplot(data = base_grafico_out_mj,mapping = aes(x = fechas,y = fit)) + 
  geom_line(col=2)+
  geom_line(mapping = aes(y=RR))+
  geom_ribbon(mapping = aes(ymin = low, ymax = up),fill=2,alpha=0.5) +
  theme_bw()+
  facet_wrap(facets = vars(factor(Canton,levels = nombres_mj)),ncol = 3,scales = 'free')+
  xlab('Time')+ylab('Relative Risk')
show(grafico_out_mj)
#save_plot(filename = 'grafico_out_MJ.pdf',plot = grafico_out_mj,base_asp = 2.2)
```

```{r}
grafico_in_mj <- ggplot(data = base_grafico_mj,mapping = aes(x = fechas,y = RR)) + 
  geom_line(col='black',lwd=0.3)+
  geom_line(mapping = aes(y=fit),col=2)+
  #geom_ribbon(mapping = aes(ymin = low, ymax = up),fill=2,alpha=0.5) +
  theme_bw()+
  facet_wrap(facets = vars(factor(Canton,levels = nombres_mj)),ncol = 3,scales = 'free')+
  xlab('Time')+ylab('Relative Risk')

# grafico_in_mj <- ggplot(data = base_grafico_mj,mapping = aes(x = fechas,y = fit)) + 
#   geom_line(col=2)+
#   geom_line(mapping = aes(y=RR),col='azure4')+
#   #geom_ribbon(mapping = aes(ymin = low, ymax = up),fill=2,alpha=0.5) +
#   theme_bw()+
#   facet_wrap(facets = vars(factor(Canton,levels = nombres_mj)),ncol = 3,scales = 'free')+
#   xlab('Date')+ylab('Relative Risk')
show(grafico_in_mj)
#save_plot(filename = 'grafico_in_MJ.pdf',plot = grafico_in_mj,base_asp = 2.2)
```

Distribucion de ancho de intervalos de prediccion:
```{r}
anchos_GAM <- base_grafico_out_g_GAM %>% mutate(width = up-low) %>%
  dplyr::select(width) %>% group_by(Canton) %>% summarise(width_b = mean(width))
anchos_RF <- base_grafico_out_g_RF %>% mutate(width = up-low) %>%
  dplyr::select(width) %>% group_by(Canton) %>% summarise(width_b = mean(width))
summary(anchos_GAM)
summary(anchos_RF)
```

Tabla de Mejores Metricas
```{r}
metricas_tot_mj <- metricas_tot_mj %>% mutate(NRMSE = round(NRMSE,4),
                                              NIS_95 = round(NIS_95,4))
kbl(metricas_tot_mj)
uu <- kbl(metricas_tot_mj,booktabs = T,format = 'latex')
```



Mapas de Riesgo Relativo:

Tres puntos en un aÃ±o dado (2015):
```{r}
distritos_st <-st_read('Data/distritos_shape/Distritos_de_Costa_Rica.shp') %>%
  filter(CODIGO!=60110) %>% mutate(CCanton = str_sub(CODIGO,1,3))
cantones_st <- distritos_st %>% group_by(CCanton) %>%
  summarise(geometry = st_union(geometry)) %>%
  ungroup() %>% mutate(CCanton = as.numeric(CCanton))
  
datos_2015_1 <- datos_totales %>% filter(Year==2013,Month==3) %>%
  select(CCanton,RR) %>% full_join(cantones_st,by = 'CCanton') %>%
  st_as_sf() %>% mutate(Mes = '2013-3')

datos_2015_2 <- datos_totales %>% filter(Year==2013,Month==7) %>%
  select(CCanton,RR) %>% full_join(cantones_st,by = 'CCanton') %>%
  st_as_sf() %>% mutate(Mes = '2013-7')

datos_2015_3 <- datos_totales %>% filter(Year==2013,Month==10) %>%
  select(CCanton,RR) %>% full_join(cantones_st,by = 'CCanton') %>%
  st_as_sf() %>% mutate(Mes = '2013-10')

datos_J_1 <- datos_totales %>% filter(Year==2005,Month==7) %>%
  select(CCanton,RR) %>% full_join(cantones_st,by = 'CCanton') %>%
  st_as_sf() %>% mutate(Mes = '2005-7')

datos_J_2 <- datos_totales %>% filter(Year==2010,Month==7) %>%
  select(CCanton,RR) %>% full_join(cantones_st,by = 'CCanton') %>%
  st_as_sf() %>% mutate(Mes = '2010-7')

datos_J_3 <- datos_totales %>% filter(Year==2018,Month==7) %>%
  select(CCanton,RR) %>% full_join(cantones_st,by = 'CCanton') %>%
  st_as_sf() %>% mutate(Mes = '2018-7')


datos_grafico <- bind_rows(datos_2015_1,datos_2015_2,datos_2015_3,
                           datos_J_1,datos_J_2,datos_J_3)

datos_grafico$Mes <- factor(datos_grafico$Mes,
                            levels = c('2013-3','2013-7','2013-10',
                                       '2005-7','2010-7','2018-7'))
RR_grafico <- ggplot(data = datos_grafico,mapping = aes(fill=RR)) +
  geom_sf()+
  facet_wrap(vars(Mes),ncol = 3)+
  theme_bw()+
  scale_fill_gradient(low = 'yellow',high = 'red',na.value = 'white')+
  theme(legend.title = element_blank(),axis.text = element_blank(),
        axis.ticks = element_blank())
RR_grafico
save_plot(filename = 'RR_maps.pdf',plot = RR_grafico)
#save_plot(filename = 'RR_maps.png',plot = RR_grafico)
#ggsave(filename = 'RR_maps.pdf',RR_grafico)
```


Rankings

```{r}
comparacion_base <- function(indice){
  RR_obs <- bases_test[[indice]] %>%
    dplyr::select(RR)
  if(metricas_tot_mj[indice,"Model"]=='GAMLSS'){
    predicciones <- data.frame(fit=predicciones_out_GAM[[indice]])
  }else{
    predicciones <- data.frame(fit=predicciones_out_RF[[indice]])
  }
  base_grafico <- data.frame(t(predicciones)) %>% 
    bind_cols(data.frame(t(RR_obs))) 
  colnames(base_grafico) <- c(paste0('Obs',1:3),paste0('Est',1:3))
  rownames(base_grafico) <- NULL
  base_grafico <- base_grafico %>%
    mutate(Canton=nombres_cantones$Canton[indice])
  return(base_grafico)
}

base_comparacion <- map_dfr(1:32,~comparacion_base(.))

Kendall_1 <- 2*distKendall(x = rank(base_comparacion$Obs1),
            y = rank(base_comparacion$Est1),type = 'ranking')/(32*31)

Kendall_2 <- 2*distKendall(x = rank(base_comparacion$Obs2),
            y = rank(base_comparacion$Est2),type = 'ranking')/(32*31)

Kendall_3 <- 2*distKendall(x = rank(base_comparacion$Obs3),
            y = rank(base_comparacion$Est3),type = 'ranking')/(32*31)

```

Grafico Casos totales:

```{r}
base_grafico_total <- datos_totales %>% 
  select(Year,Month,CasesCR,PoblacionCR) %>%
  distinct() %>%
  mutate(Incidence_CR = 1e5*CasesCR/PoblacionCR,
         Time=make_date(year = Year,month = Month,day = 1))


incidencia_CR <- ggplot(data = base_grafico_total) +
  geom_line(mapping = aes(x = Time,y = Incidence_CR))+
  theme_bw()+
  ylab('Incidence Rate (CR) per 10^5')
incidencia_CR
```



Grafico Casos Pacifico:

```{r}
base_grafico_pacifico <- datos_totales %>% 
  filter(str_sub(CCanton,start = 1,end = 1) %in% c('5','6')) %>%
  select(Year,Month,Cases,Poblacion) %>%
  distinct() %>%
  group_by(Year,Month) %>%
  summarise(Cases_s = sum(Cases),Poblacion_s = sum(Poblacion)) %>%
  ungroup() %>%
  mutate(Incidence_s = 1e5*Cases_s/Poblacion_s,
         Time=make_date(year = Year,month = Month,day = 1))


incidencia_pacifico <- ggplot(data = base_grafico_pacifico) +
  geom_line(mapping = aes(x = Time,y = Incidence_s))+
  theme_bw()+
  ylab('Incidence Rate (Pacific) per 10^5')
incidencia_pacifico
```

Grafico Casos Atlantico:

```{r}
base_grafico_atlantico <- datos_totales %>% 
  filter(str_sub(CCanton,start = 1,end = 1) %in% c('7')) %>%
  select(Year,Month,Cases,Poblacion) %>%
  distinct() %>%
  group_by(Year,Month) %>%
  summarise(Cases_s = sum(Cases),Poblacion_s = sum(Poblacion)) %>%
  ungroup() %>%
  mutate(Incidence_s = 1e5*Cases_s/Poblacion_s,
         Time=make_date(year = Year,month = Month,day = 1))


incidencia_atlantico <- ggplot(data = base_grafico_atlantico) +
  geom_line(mapping = aes(x = Time,y = Incidence_s))+
  theme_bw()+
  ylab('Incidence Rate (Atlantic) per 10^5')
incidencia_atlantico
```
